rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    // A user is considered the owner of a family if they created it.
    function isFamilyOwner(familyId) {
      return isSignedIn()
        && get(/databases/$(database)/documents/families/$(familyId))
             .data.created_by_user_id == request.auth.uid;
    }

    // A user is a family member if they are the owner OR have a familyMembers entry
    function isFamilyMember(familyId) {
      return isSignedIn() && (
        isFamilyOwner(familyId) ||
        exists(/databases/$(database)/documents/familyMembers/$(familyId + '_' + request.auth.uid)) ||
        exists(/databases/$(database)/documents/familyMembers/$(request.auth.uid + '_' + familyId))
      );
    }

    // USERS: each user can only read/update their own profile.
    match /users/{userId} {
      allow read, update: if isSignedIn() && request.auth.uid == userId;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow delete: if false;
    }

    // FAMILY MEMBERS: track who has access to a family
    // Document ID format: {familyId}_{userId}
    match /familyMembers/{memberId} {
      // Create: family owner can add members, or user can add themselves if invited
      allow create: if isSignedIn()
        && (isFamilyOwner(request.resource.data.family_id)
            || request.resource.data.user_id == request.auth.uid);

      // Read: users can read their own memberships, or family members can see who else is in their family
      // Note: We allow reading own memberships first to avoid circular dependency in queries
      allow read: if isSignedIn()
        && (resource.data.user_id == request.auth.uid
            || isFamilyMember(resource.data.family_id));

      // Update: family owner can update roles, or user can update their own status
      allow update: if isSignedIn()
        && (isFamilyOwner(resource.data.family_id)
            || resource.data.user_id == request.auth.uid);

      // Delete: family owner can remove members
      allow delete: if isSignedIn()
        && isFamilyOwner(resource.data.family_id);
    }

    // FAMILIES: family members can see and edit their families.
    match /families/{familyId} {
      // Create: authenticated user creating a family they own
      allow create: if isSignedIn()
        && request.resource.data.created_by_user_id == request.auth.uid;

      // Read / update: family members
      allow read, update: if isFamilyMember(familyId);

      // Delete: only family owner can delete
      allow delete: if isFamilyOwner(familyId);
    }

    // PERSONS: belong to a family via family_id.
    // Read: family members can read all persons in their family.
    // Also allow read for unclaimed persons (no ownerUserId) to support invitation claim flow.
    // Update/delete: family members OR person owner (ownerUserId) OR family owner.
    match /persons/{personId} {
      // Create: require auth and that the user is a member of the target family
      allow create: if isSignedIn()
        && isFamilyMember(request.resource.data.family_id);

      // Read: 
      // 1. Family members can read all persons in their family
      // 2. Allow read for unclaimed persons (no ownerUserId field or empty) - needed for invitation claim flow
      //    The frontend validates the invitation token before showing person data
      allow read: if (isSignedIn()
        && isFamilyMember(resource.data.family_id))
        || (!('ownerUserId' in resource.data) || resource.data.ownerUserId == null || resource.data.ownerUserId == ''); // Unclaimed persons

      // Update/delete: family members, claimed owner of that person, or family owner
      allow update, delete: if isSignedIn()
        && (isFamilyMember(resource.data.family_id)
          || resource.data.ownerUserId == request.auth.uid
          || isFamilyOwner(resource.data.family_id));
    }

    // USER RELATIONSHIPS: how a given person relates to the current user
    match /userRelationships/{relId} {
      // Read/write: user can manage their own relationships, or family members can manage any in their family
      allow read, write: if isSignedIn()
        && (request.auth.uid == resource.data.user_id
          || request.auth.uid == request.resource.data.user_id
          || isFamilyMember(resource.data.family_id));
    }

    // RELATIONSHIPS: simple parent-child relationships within a family.
    match /relationships/{relId} {
      // Create: require auth and membership in the family
      allow create: if isSignedIn()
        && isFamilyMember(request.resource.data.family_id);

      // Read/update/delete: family members or family owner
      allow read, update, delete: if isSignedIn()
        && (isFamilyMember(resource.data.family_id)
          || isFamilyOwner(resource.data.family_id));
    }

    // SPOUSE RELATIONSHIPS: spouse relationships within a family.
    match /spouseRelationships/{relId} {
      // Create: require auth and membership in the family
      allow create: if isSignedIn()
        && isFamilyMember(request.resource.data.family_id);

      // Read/update/delete: family members or family owner
      allow read, update, delete: if isSignedIn()
        && (isFamilyMember(resource.data.family_id)
          || isFamilyOwner(resource.data.family_id));
    }

    // PERSON INVITATIONS: invitations to claim a person's profile
    match /personInvitations/{invitationId} {
      // Create: family owner can create invitations for persons in their family
      allow create: if isSignedIn()
        && isFamilyOwner(request.resource.data.family_id);

      // Read: allow reading invitations (token is in URL, so this is acceptable)
      // In production, you might want to restrict this further
      allow read: if true;

      // Update: only to mark as accepted/claimed (by the invited user)
      allow update: if isSignedIn()
        && (isFamilyOwner(resource.data.family_id)
          || (request.auth.token.email != null
            && request.auth.token.email.lower() == resource.data.email.lower()
            && request.resource.data.status == 'accepted'
            && resource.data.status == 'pending'));

      // Delete: family owner can delete invitations
      allow delete: if isSignedIn()
        && isFamilyOwner(resource.data.family_id);
    }

    // DOCUMENTS: photos, certificates, audio, video files
    match /documents/{documentId} {
      // Create: family members can create documents for persons in their family
      allow create: if isSignedIn()
        && isFamilyMember(request.resource.data.family_id);

      // Read: family members can read all documents in their family
      allow read: if isSignedIn()
        && isFamilyMember(resource.data.family_id);

      // Update: family members or family owner can update documents
      allow update: if isSignedIn()
        && (isFamilyMember(resource.data.family_id)
          || isFamilyOwner(resource.data.family_id));

      // Delete: family members or family owner can delete documents
      allow delete: if isSignedIn()
        && (isFamilyMember(resource.data.family_id)
          || isFamilyOwner(resource.data.family_id));
    }

    // STORIES: oral history and family stories
    match /stories/{storyId} {
      // Create: family members can create stories for persons in their family
      allow create: if isSignedIn()
        && isFamilyMember(request.resource.data.family_id);

      // Read: family members can read all stories in their family
      allow read: if isSignedIn()
        && isFamilyMember(resource.data.family_id);

      // Update: family members or family owner can update stories
      allow update: if isSignedIn()
        && (isFamilyMember(resource.data.family_id)
          || isFamilyOwner(resource.data.family_id));

      // Delete: family members or family owner can delete stories
      allow delete: if isSignedIn()
        && (isFamilyMember(resource.data.family_id)
          || isFamilyOwner(resource.data.family_id));
    }
  }

  // Verifications collection
  match /verifications/{verificationId} {
    allow read: if request.auth != null && isFamilyMember(resource.data.family_id);
    allow create: if request.auth != null && isFamilyMember(request.resource.data.family_id);
    allow update, delete: if request.auth != null && 
      (resource.data.verified_by == request.auth.uid || 
       isFamilyOwner(resource.data.family_id));
  }
}


